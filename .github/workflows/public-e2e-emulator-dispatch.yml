name: public-e2e-emulator-dispatch

on:
  workflow_dispatch:
    inputs:
      source_ref:
        description: "SOURCE_REPO ref/branch/tag/commit"
        required: true
        type: string
      artifact_name:
        description: "E2E artifact name"
        required: true
        default: "e2e-output"
        type: string
      e2e_out_dir:
        description: "Output dir in SOURCE_REPO workspace"
        required: true
        default: "artifacts/e2e/ci"
        type: string
      api_level:
        description: "Android emulator API level"
        required: true
        default: "30"
        type: string
      run_voice_scenario:
        description: "Run optional IME voice scenario"
        required: true
        default: true
        type: boolean
      run_fake_transcript_check:
        description: "Run fake transcript injection assertion"
        required: true
        default: true
        type: boolean
      fake_transcript_text:
        description: "Optional fake transcript text"
        required: false
        default: ""
        type: string
      input_component:
        description: "Input activity component for IME scenario"
        required: false
        default: "com.osfans.trime.debug/com.osfans.trime.ui.e2e.E2eInputActivity"
        type: string
      focus_x:
        description: "Optional input focus x"
        required: false
        default: ""
        type: string
      focus_y:
        description: "Optional input focus y"
        required: false
        default: ""
        type: string
      voice_key_x:
        description: "Optional voice key x"
        required: false
        default: ""
        type: string
      voice_key_y:
        description: "Optional voice key y"
        required: false
        default: ""
        type: string
      record_seconds:
        description: "Optional record duration seconds"
        required: false
        default: "1"
        type: string
      e2e_timeout_seconds:
        description: "Timeout for run-trime-e2e.sh command"
        required: false
        default: "4800"
        type: string
      emulator_options:
        description: "Emulator options passed to android-emulator-runner"
        required: false
        default: "-no-window -gpu swiftshader_indirect -no-boot-anim"
        type: string
      collect_audio_diagnostics:
        description: "Collect host audio diagnostics"
        required: false
        default: true
        type: boolean
      qemu_audio_drv:
        description: "QEMU audio backend for emulator"
        required: false
        default: "pa"
        type: string
      bootstrap_pulseaudio:
        description: "Start pulseaudio and create virtual source on runner"
        required: false
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  e2e-emulator:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout build repo
        uses: actions/checkout@v4

      - name: Prepare SSH key
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.SOURCE_REPO_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone private source repo
        shell: bash
        env:
          SOURCE_REPO: ${{ secrets.SOURCE_REPO }}
          SOURCE_REF: ${{ inputs.source_ref }}
        run: |
          set -euo pipefail
          test -n "$SOURCE_REPO"
          git clone "git@github.com:${SOURCE_REPO}.git" source
          cd source
          git checkout "$SOURCE_REF"

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Configure git identity for build metadata
        shell: bash
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Collect host audio diagnostics
        if: ${{ always() && inputs.collect_audio_diagnostics }}
        shell: bash
        run: |
          set +e
          mkdir -p host-audio-diagnostics
          date -Iseconds > host-audio-diagnostics/timestamp.txt
          uname -a > host-audio-diagnostics/uname.txt
          printenv | grep -E '^(AUDIO|PULSE|QEMU_AUDIO|ALSA|PIPEWIRE)' | sort > host-audio-diagnostics/env-audio.txt || true
          ls -la /dev/snd > host-audio-diagnostics/dev-snd.txt 2>&1 || true
          cat /proc/asound/cards > host-audio-diagnostics/proc-asound-cards.txt 2>&1 || true
          cat /proc/asound/devices > host-audio-diagnostics/proc-asound-devices.txt 2>&1 || true
          (command -v arecord && arecord -l) > host-audio-diagnostics/arecord-l.txt 2>&1 || true
          (command -v aplay && aplay -l) > host-audio-diagnostics/aplay-l.txt 2>&1 || true
          (command -v pactl && pactl info) > host-audio-diagnostics/pactl-info.txt 2>&1 || true
          (command -v pw-cli && pw-cli info 0) > host-audio-diagnostics/pipewire-info.txt 2>&1 || true

      - name: Build debug APK
        shell: bash
        run: |
          set -euo pipefail
          cd source/trime
          SDK_DIR="${ANDROID_SDK_ROOT:-${ANDROID_HOME:-}}"
          if [[ -z "$SDK_DIR" ]]; then
            echo "ANDROID_SDK_ROOT/ANDROID_HOME is not set" >&2
            exit 1
          fi
          echo "sdk.dir=$SDK_DIR" > local.properties
          CMAKE_VERSION=3.22.1 ./gradlew :app:assembleDebug

      - name: Bootstrap host PulseAudio (optional)
        if: ${{ always() && inputs.collect_audio_diagnostics && inputs.bootstrap_pulseaudio }}
        shell: bash
        run: |
          set +e
          mkdir -p host-audio-diagnostics
          if ! command -v pulseaudio >/dev/null 2>&1 || ! command -v pactl >/dev/null 2>&1; then
            (sudo apt-get update -y && sudo apt-get install -y pulseaudio pulseaudio-utils) > host-audio-diagnostics/apt-install-pulseaudio.txt 2>&1 || true
          fi
          (command -v pulseaudio) > host-audio-diagnostics/pulseaudio-bin.txt 2>&1 || true
          (command -v pactl) > host-audio-diagnostics/pactl-bin.txt 2>&1 || true
          pulseaudio --check || pulseaudio --start --daemonize=yes --exit-idle-time=-1 >/dev/null 2>&1 || true
          sleep 1
          (command -v pactl && pactl info) > host-audio-diagnostics/pactl-info-after-bootstrap.txt 2>&1 || true
          (command -v pactl && pactl list short sinks) > host-audio-diagnostics/pactl-sinks-after-bootstrap.txt 2>&1 || true
          (command -v pactl && pactl list short sources) > host-audio-diagnostics/pactl-sources-after-bootstrap.txt 2>&1 || true
          (command -v pactl && pactl load-module module-null-sink sink_name=ci_sink channels=1 rate=16000 sink_properties=device.description=ci_sink) > host-audio-diagnostics/pactl-load-null-sink.txt 2>&1 || true
          (command -v pactl && pactl load-module module-remap-source source_name=ci_mic master=ci_sink.monitor source_properties=device.description=ci_mic) > host-audio-diagnostics/pactl-load-remap-source.txt 2>&1 || true
          (command -v pactl && pactl set-default-source ci_mic) > host-audio-diagnostics/pactl-set-default-source.txt 2>&1 || true
          (command -v pactl && pactl list short sinks) > host-audio-diagnostics/pactl-sinks-post-virtual.txt 2>&1 || true
          (command -v pactl && pactl list short sources) > host-audio-diagnostics/pactl-sources-post-virtual.txt 2>&1 || true

      - name: Run E2E on cloud emulator
        id: run_e2e
        continue-on-error: true
        env:
          QEMU_AUDIO_DRV: ${{ inputs.qemu_audio_drv }}
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ inputs.api_level }}
          arch: x86_64
          profile: pixel_5
          cores: 2
          ram-size: 4096M
          heap-size: 1024M
          disk-size: 4096M
          disable-animations: true
          emulator-options: ${{ inputs.emulator_options }}
          script: |
            timeout --signal=INT --kill-after=30s 600s bash -lc 'cd source && ./tool/e2e/install-debug-apk.sh --serial emulator-5554 --package com.osfans.trime.debug' || exit $?
            timeout --signal=INT --kill-after=120s "${{ inputs.e2e_timeout_seconds }}"s bash -lc 'cd source && ./tool/e2e/run-trime-e2e.sh --serial emulator-5554 --package com.osfans.trime.debug --activity com.osfans.trime.ui.main.MainActivity --out-dir "${{ inputs.e2e_out_dir }}" --input-component "${{ inputs.input_component }}" --focus-x "${{ inputs.focus_x }}" --focus-y "${{ inputs.focus_y }}" --voice-key-x "${{ inputs.voice_key_x }}" --voice-key-y "${{ inputs.voice_key_y }}" --record-seconds "${{ inputs.record_seconds }}" --run-fake-transcript-check "${{ inputs.run_fake_transcript_check }}" --fake-transcript-text "${{ inputs.fake_transcript_text }}"' || exit $?

      - name: Upload E2E artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: |
            source/${{ inputs.e2e_out_dir }}/**
            source/trime/app/build/outputs/apk/debug/*.apk
            host-audio-diagnostics/**
          if-no-files-found: warn
          retention-days: 1

      - name: Fail workflow when E2E step failed
        if: ${{ always() && steps.run_e2e.outcome != 'success' }}
        shell: bash
        run: |
          echo "Run E2E step outcome: ${{ steps.run_e2e.outcome }}"
          exit 1
